# 청킹(Chunking)과 텍스트 추출의 차이점

## 🤔 질문: "청킹 능력이 떨어진다"는 것은 PDF→TXT 해석력(양)이 적다는 것인가?

**답변: 아니요, 다른 개념입니다!**

---

## 📊 두 가지 개념 비교

### 1. PDF → TXT 변환 (텍스트 추출)

**단계**: PDF 파일 → 텍스트 문자열

**목적**: PDF에서 **얼마나 많은 텍스트**를 **얼마나 정확하게** 추출하는가

**예시:**
```
PDF (이미지):
┌─────────────────────────────┐
│ 제1조 (보험금 지급)         │
│ 보험금은 다음과 같이 지급..  │
│ ┌───┬───┬───┐              │
│ │ A │ B │ C │              │
│ └───┴───┴───┘              │
└─────────────────────────────┘

↓ 텍스트 추출 (pdfplumber)

"제1조 (보험금 지급)\n보험금은 다음과 같이 지급..\nA B C"
→ 품질: 70% (표 구조 손실)

↓ 텍스트 추출 (Upstage)

"제1조 (보험금 지급)\n보험금은 다음과 같이 지급..\n[표: A | B | C]"
→ 품질: 95% (표 구조 유지)
```

**평가 기준:**
- ✅ **추출량**: 얼마나 많은 텍스트를 추출했는가?
- ✅ **정확도**: 원본과 얼마나 일치하는가?
- ✅ **구조 유지**: 표, 레이아웃 등이 보존되는가?

---

### 2. 청킹 (Chunking)

**단계**: 텍스트 문자열 → 여러 개의 작은 조각 (청크)

**목적**: 추출된 텍스트를 **의미 있는 단위**로 나누는가

**예시:**

**나쁜 청킹 (일반적인 방법):**
```python
# 단순히 1000자씩 자르기
text = "제1조 (보험금 지급) 보험금은... 제2조 (보험료 납입) 보험료는..."

chunk_1 = text[0:1000]    # "제1조 (보험금 지급) 보험금은... 제2조 (보험료"
chunk_2 = text[1000:2000] # "납입) 보험료는... 제3조..."
```

**문제점:**
- ❌ 제2조가 중간에 잘림 → **문맥 손실**
- ❌ "제2조 (보험료 납입)"의 제목과 내용이 분리됨
- ❌ 검색 시 "보험료 납입"으로 검색해도 제대로 못 찾음

**좋은 청킹 (Upstage 스마트 청킹):**
```python
# 조항 단위로 스마트하게 분할
chunk_1 = {
    'text': "제1조 (보험금 지급) 보험금은 다음과 같이...",
    'metadata': {
        'chapter': 1,
        'article': 1,
        'title': '보험금 지급'
    }
}

chunk_2 = {
    'text': "제2조 (보험료 납입) 보험료는 매월...",
    'metadata': {
        'chapter': 1,
        'article': 2,
        'title': '보험료 납입'
    }
}
```

**장점:**
- ✅ 제2조가 하나의 청크로 유지 → **문맥 보존**
- ✅ 제목과 내용이 함께 있음
- ✅ 검색 시 정확히 찾을 수 있음

**평가 기준:**
- ✅ **문맥 유지**: 의미 단위가 깨지지 않는가?
- ✅ **검색 정확도**: 원하는 정보를 정확히 찾을 수 있는가?
- ✅ **메타데이터**: 각 청크의 위치, 제목 등을 알 수 있는가?

---

## 🔍 실제 예시로 비교

### 상황: 보험약관 PDF (50페이지) 처리

### 시나리오 1: pdfplumber + 단순 청킹

**1단계: PDF → TXT (pdfplumber)**
```
추출된 텍스트:
- 길이: 45,000자
- 품질: 70% (표 일부 손실)
- 조항 인식: 30개 인식 (실제 50개)
```

**2단계: TXT → 청크 (단순 분할)**
```python
# 1000자씩 단순 분할
chunks = []
chunk_size = 1000

for i in range(0, len(text), chunk_size):
    chunks.append(text[i:i+chunk_size])

# 결과: 45개 청크 생성
```

**문제점:**
```
청크 #23: "...보험금은 다음과 같이 지급합니다. 1. 사망보험금: 10..."
청크 #24: "00만원 2. 암진단비: 3000만원 제15조 (보험료 납입..."
         ↑ 제15조 제목이 끝에 잘림!

청크 #25: "보험료는 매월 납입하여야 합니다. 1. 납입기간: 20년..."
         ↑ 제15조 내용만 있고 제목이 없음!
```

**결과:**
- ❌ "보험료 납입"으로 검색 시 청크 #24만 나옴 (제목만 있음)
- ❌ 청크 #25는 제목이 없어서 검색 안 됨
- ❌ 학습 시 문맥이 부족하여 이해도 저하

---

### 시나리오 2: Upstage + 스마트 청킹

**1단계: PDF → TXT (Upstage)**
```
추출된 텍스트:
- 길이: 52,000자 (pdfplumber 대비 +15%)
- 품질: 95% (표 완벽 유지)
- 조항 인식: 50개 모두 인식
- 구조 분석: 제1장~제5장 자동 파악
```

**2단계: TXT → 청크 (스마트 분할)**
```python
# Upstage 스마트 청킹
chunks = await parser.extract_chunks_with_context(
    pdf_url,
    chunk_size=1000,
    overlap=200
)

# 결과: 52개 청크 생성 (조항 단위)
```

**결과:**
```
청크 #23:
{
    'text': "제14조 (사망보험금 지급) 보험금은 다음과 같이 지급합니다. 1. 사망보험금: 1000만원 2. 암진단비: 3000만원",
    'metadata': {
        'chapter': 3,
        'chapter_title': '보험금 지급',
        'article': 14,
        'article_title': '사망보험금 지급',
        'page': 25
    }
}

청크 #24:
{
    'text': "제15조 (보험료 납입) 보험료는 매월 납입하여야 합니다. 1. 납입기간: 20년 2. 납입주기: 매월...",
    'metadata': {
        'chapter': 3,
        'chapter_title': '보험금 지급',
        'article': 15,
        'article_title': '보험료 납입',
        'page': 26
    }
}
```

**장점:**
- ✅ "보험료 납입"으로 검색 시 청크 #24 정확히 찾음
- ✅ 제15조의 제목과 내용이 하나의 청크에 있음
- ✅ 메타데이터로 위치, 장/조 정보 포함
- ✅ 학습 시 문맥이 풍부하여 이해도 향상

---

## 📈 영향 비교

### A. 텍스트 추출 품질 (PDF → TXT)

| 항목 | pdfplumber | Upstage | 영향 |
|------|-----------|---------|------|
| 추출량 | 45,000자 | 52,000자 (+15%) | 🔵 정보량 증가 |
| 표 추출 | 30% | 95% | 🔵 데이터 완전성 |
| 조항 인식 | 60% | 100% | 🔵 구조 이해 |

**영향:**
- 🔵 **학습 데이터 양 증가** (15-30%)
- 🔵 **학습 품질 향상** (표, 구조 정보 포함)

---

### B. 청킹 품질 (TXT → 청크)

| 항목 | 단순 청킹 | 스마트 청킹 | 영향 |
|------|----------|-----------|------|
| 문맥 유지 | 50% | 95% | 🟢 검색 정확도 |
| 의미 분할 | 무작위 | 조항 단위 | 🟢 이해도 |
| 메타데이터 | 없음 | 풍부 | 🟢 필터링 가능 |

**영향:**
- 🟢 **검색 정확도 향상** (60-80% → 95%+)
- 🟢 **학습 효율 향상** (문맥 유지)
- 🟢 **사용자 경험 향상** (정확한 답변)

---

## 🎯 실제 시나리오

### 시나리오: 사용자 질문 "보험료 납입 방법은?"

#### Case 1: pdfplumber + 단순 청킹

```
1. 텍스트 추출 (pdfplumber)
   → "제15조 보험료 납입" 조항 일부만 추출 (표 누락)

2. 단순 청킹
   → 제15조가 3개 청크로 분할됨
   → 청크 A: "제15조 (보험료"
   → 청크 B: "납입) 보험료는..."
   → 청크 C: "...매월 납입"

3. 검색
   → "보험료 납입" 검색 시 청크 B만 찾음
   → 제목 없어서 문맥 부족

4. AI 답변
   → "보험료는 매월 납입하여야 합니다" (제목 누락, 불완전한 답변)
```

**사용자 만족도: ⭐⭐☆☆☆ (40%)**

---

#### Case 2: Upstage + 스마트 청킹

```
1. 텍스트 추출 (Upstage)
   → "제15조 보험료 납입" 조항 완벽 추출 (표 포함)

2. 스마트 청킹
   → 제15조가 하나의 청크로 유지
   → {
       'text': "제15조 (보험료 납입) 보험료는 매월 납입...",
       'metadata': {
           'article': 15,
           'title': '보험료 납입',
           'chapter': 3
       }
     }

3. 검색
   → "보험료 납입" 검색 시 정확히 제15조 청크 찾음
   → 제목, 내용, 표 모두 포함

4. AI 답변
   → "제15조에 따르면, 보험료 납입 방법은 다음과 같습니다:
      1. 납입기간: 20년
      2. 납입주기: 매월
      3. 납입방법: 자동이체 또는 카드결제
      자세한 내용은 약관 26페이지를 참고하세요."
```

**사용자 만족도: ⭐⭐⭐⭐⭐ (95%)**

---

## 💡 요약

### 질문: "청킹 능력이 떨어진다" = "PDF→TXT 해석력이 적다"?

**답변: 아니요!**

### 올바른 이해:

1. **PDF → TXT 변환 (텍스트 추출)**
   - **무엇**: 얼마나 많은 텍스트를 정확히 추출하는가?
   - **측정**: 추출량(글자 수), 품질(정확도), 구조 유지
   - **pdfplumber 문제**: 표 손실, OCR 품질 낮음, 구조 인식 부족
   - **Upstage 개선**: +15-30% 더 많은 텍스트, 표 완벽 추출, 구조 자동 인식

2. **청킹 (Chunking)**
   - **무엇**: 추출된 텍스트를 의미 있는 단위로 나누는가?
   - **측정**: 문맥 유지, 검색 정확도, 메타데이터 풍부도
   - **단순 청킹 문제**: 문맥 손실, 검색 부정확, 메타데이터 없음
   - **스마트 청킹 개선**: 조항 단위 유지, 검색 95%+, 메타데이터 자동 추가

### 두 가지 모두 중요!

```
좋은 텍스트 추출 (Upstage)
    ↓
  +
    ↓
좋은 청킹 (스마트 청킹)
    ↓
  =
    ↓
최고의 학습 품질 & 검색 정확도
```

### 기대 효과:

| 조합 | 추출 품질 | 청킹 품질 | 전체 점수 |
|------|----------|----------|-----------|
| pdfplumber + 단순 청킹 | 70% | 50% | **60점** |
| pdfplumber + 스마트 청킹 | 70% | 95% | **75점** |
| Upstage + 단순 청킹 | 95% | 50% | **72점** |
| **Upstage + 스마트 청킹** | **95%** | **95%** | **95점** ⭐ |

---

## 🎯 결론

**청킹 능력**과 **텍스트 추출 품질**은 **별개**이지만 **함께 작용**합니다!

- ✅ **Upstage Document Parse**: 텍스트 추출 품질 향상 (PDF → TXT)
- ✅ **스마트 청킹**: 청킹 품질 향상 (TXT → 청크)
- ✅ **함께 사용**: 최고의 학습 효과 & 검색 정확도

**권장: Upstage + 스마트 청킹을 함께 사용하세요!** 🚀

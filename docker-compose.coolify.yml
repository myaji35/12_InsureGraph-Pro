version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: insuregraph
      POSTGRES_USER: insuregraph_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - insuregraph-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U insuregraph_user -d insuregraph"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - insuregraph-network
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j Graph Database
  neo4j:
    image: neo4j:5.14
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_memory_heap_max__size: 2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - insuregraph-network
    restart: unless-stopped
    ports:
      - "17474:7474"
      - "17687:7687"
    labels:
      - "coolify.managed=true"
      - "coolify.type=database"
      - "traefik.enable=true"
      - "traefik.http.routers.insuregraph-neo4j.rule=Host(`InsureGraphPro.34.64.191.91`) && PathPrefix(`/neo4j`)"
      - "traefik.http.routers.insuregraph-neo4j.entrypoints=web,websecure"
      - "traefik.http.services.insuregraph-neo4j.loadbalancer.server.port=7474"
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: insuregraph
      POSTGRES_USER: insuregraph_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Neo4j
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}

      # Security
      SECRET_KEY: ${SECRET_KEY}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}

      # API Keys
      UPSTAGE_API_KEY: ${UPSTAGE_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}

      # Environment
      ENVIRONMENT: production
      DEBUG: false
      LOG_LEVEL: INFO

      # CORS - Unified domain format
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
    volumes:
      - ./backend/logs:/app/logs
      - ./backend/data:/app/data
    networks:
      - insuregraph-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "18001:8080"
    labels:
      - "coolify.managed=true"
      - "coolify.type=application"
      - "coolify.port=8080"
      - "traefik.enable=true"
      - "traefik.http.routers.insuregraph-backend.rule=Host(`InsureGraphPro.34.64.191.91`) && PathPrefix(`/api`)"
      - "traefik.http.routers.insuregraph-backend.entrypoints=web,websecure"
      - "traefik.http.services.insuregraph-backend.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NODE_ENV: production
    networks:
      - insuregraph-network
    depends_on:
      - backend
    restart: unless-stopped
    ports:
      - "18000:3000"
    labels:
      - "coolify.managed=true"
      - "coolify.type=application"
      - "coolify.port=3000"
      - "traefik.enable=true"
      - "traefik.http.routers.insuregraph-frontend.rule=Host(`InsureGraphPro.34.64.191.91`)"
      - "traefik.http.routers.insuregraph-frontend.entrypoints=web,websecure"
      - "traefik.http.routers.insuregraph-frontend.priority=1"
      - "traefik.http.services.insuregraph-frontend.loadbalancer.server.port=3000"

  # Celery Worker
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.celery_app worker --loglevel=info --concurrency=4
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: insuregraph
      POSTGRES_USER: insuregraph_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      SECRET_KEY: ${SECRET_KEY}
      UPSTAGE_API_KEY: ${UPSTAGE_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    volumes:
      - ./backend/logs:/app/logs
      - ./backend/data:/app/data
    networks:
      - insuregraph-network
    depends_on:
      - postgres
      - redis
      - neo4j
    restart: unless-stopped
    labels:
      - "coolify.managed=true"
      - "coolify.type=worker"

volumes:
  postgres_data:
  redis_data:
  neo4j_data:
  neo4j_logs:

networks:
  insuregraph-network:
    driver: bridge
